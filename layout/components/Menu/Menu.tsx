import React, {useContext, KeyboardEvent, useState} from 'react';import {AppContext} from "../../../context/app.context";import { MenuItem, PageItem} from "../../../interfaces/menu.interface";import styles from './Menu.module.css';import cn from "classnames";import Link from 'next/link';import {useRouter} from "next/router";import {firstLevelMenu} from "../../../helpers/helpers";import {motion,useReducedMotion} from 'framer-motion';const Menu = (): JSX.Element => {    const {menu, firstCategory,setMenu} = useContext(AppContext);    const router = useRouter();    const [announce,setAnnounce] = useState<'closed' | 'opened' | undefined>();    const shouldReduceMotion = useReducedMotion();    const variants = {        visible:{            marginBottom: 20,            transition:shouldReduceMotion ? {}:{                when:'beforeChildren',                staggerChildren:0.1            }        },        hidden:{marginBottom:0}    };    const variantsChildren = {        visible:{            opacity:1,            height:29        },        hidden:{opacity:shouldReduceMotion ?1: 0,height:0}    };    const openSecondLevelKey = (key:KeyboardEvent,category:string)=> {        if(key.code == 'Space' || key.code == 'Enter'){            key.preventDefault();            openSecondLevelMenu(category);        }        return;    };    const openSecondLevelMenu = (secondCategory:string) => {        setMenu && setMenu(menu.map(m=>{            if(m._id.secondCategory == secondCategory){                setAnnounce(m.isOpened ? 'closed' : 'opened');                m.isOpened = !m.isOpened;            }            return m;        }));    };    const buildFirstLevelMenu = () => {        return (            <ul className={styles.firstLevelList}>                {firstLevelMenu.map((item) => (                    <li key={item.route} aria-expanded={item.id == firstCategory}>                        <Link href={`/${item.route}`}><a>                            <div className={cn(styles.firstLevel, {                                [styles.firstLevelActive]: item.id == firstCategory                            })}>                                {item.icon}                                <span>{item.name}</span>                            </div>                        </a></Link>                        {item.id == firstCategory && buildSecondLevelMenu(menu, item.route)}                    </li>                ))}            </ul>        );    };    const buildSecondLevelMenu = (menuItem: MenuItem[], route: string) => {        return (            <ul className={styles.secondBlock}>                {menuItem.map(m => {                    if(m.pages.map(p=>p.alias).includes(router.asPath.split('/')[2])){                        m.isOpened = true;                    }                    return (                        <li key={m._id.secondCategory}>                            <button                                 onKeyDown={(key:KeyboardEvent)=>openSecondLevelKey(key,m._id.secondCategory)}                                 className={styles.secondLevel}                                 aria-expanded={m.isOpened}                                 onClick={()=>openSecondLevelMenu(m._id.secondCategory)}>                                {m._id.secondCategory}                            </button>                            <motion.ul                                layout                                variants={variants}                                initial={m.isOpened ? 'visible': 'hidden'}                                animate={m.isOpened ? 'visible': 'hidden'}                                className={styles.secondLevelBlock}>                                {buildThirdLevelMenu(m.pages, route,m.isOpened ?? false)}                            </motion.ul>                        </li>                    );                })}            </ul>        );    };    const buildThirdLevelMenu = (pages: PageItem[], route: string,isOpened:boolean) => {        return (                pages.map(p => (                    <motion.li                        key={p._id}                        variants={variantsChildren}                    >                        <Link href={`/${route}/${p.alias}`} ><a                            tabIndex={!isOpened ? -1 : 0}                            className={cn(styles.thirdLevel, {                                [styles.thirdLevelActive]: router.asPath == `/${route}/${p.alias}`                            })}                            aria-current={`/${route}/${p.alias}` === router.asPath ? 'page':false}                        >                            {p.category}                        </a></Link>                    </motion.li>                ))        );    };    return (        <nav className={styles.menu} role={'navigation'}>            {announce && <span role={'log'} className="visuallyHidden">{announce == 'opened' ? 'opened': 'closed'}</span>}            {buildFirstLevelMenu()}        </nav>    );};export default Menu;